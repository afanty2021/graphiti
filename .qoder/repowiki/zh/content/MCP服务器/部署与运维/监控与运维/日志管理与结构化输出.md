# 日志管理与结构化输出

<cite>
**本文档引用的文件**   
- [graphiti_mcp_server.py](file://mcp_server/src/graphiti_mcp_server.py)
- [.env.example](file://mcp_server/.env.example)
- [docker-compose.yml](file://mcp_server/docker/docker-compose.yml)
- [Dockerfile](file://mcp_server/docker/Dockerfile)
</cite>

## 目录
1. [简介](#简介)
2. [日志格式配置](#日志格式配置)
3. [Uvicorn日志处理器重写](#uvicorn日志处理器重写)
4. [Docker部署中的日志持久化](#docker部署中的日志持久化)
5. [集中式日志收集建议](#集中式日志收集建议)
6. [结论](#结论)

## 简介
本文档详细说明了MCP服务器的全面日志管理方案。文档涵盖了结构化日志格式的配置、Uvicorn日志处理器的重写、Docker部署中的日志持久化策略以及集中式日志收集的集成建议。

## 日志格式配置
MCP服务器使用Python的`logging`模块进行日志记录，配置了结构化的日志格式，包含时间戳、日志级别、模块名和消息。日志格式通过`LOG_FORMAT`和`DATE_FORMAT`常量进行自定义。

```python
LOG_FORMAT = '%(asctime)s - %(name)s - %(levelname)s - %(message)s'
DATE_FORMAT = '%Y-%m-%d %H:%M:%S'
```

日志配置通过`logging.basicConfig`函数进行初始化，设置日志级别为`INFO`，使用自定义的格式和日期格式，并将日志输出到标准错误流。

```python
logging.basicConfig(
    level=logging.INFO,
    format=LOG_FORMAT,
    datefmt=DATE_FORMAT,
    stream=sys.stderr,
)
```

此外，文档还配置了特定的日志记录器，如`uvicorn`、`uvicorn.access`和`mcp.server.streamable_http_manager`，以减少访问日志和MCP日志的噪音。

**Section sources**
- [graphiti_mcp_server.py](file://mcp_server/src/graphiti_mcp_server.py#L78-L95)

## Uvicorn日志处理器重写
`configure_uvicorn_logging`函数用于重写Uvicorn日志处理器，以保持日志格式的一致性。该函数遍历`uvicorn`、`uvicorn.error`和`uvicorn.access`日志记录器，清除现有的处理器，并添加新的处理器，使用与主日志配置相同的格式。

```python
def configure_uvicorn_logging():
    """Configure uvicorn loggers to match our format after they're created."""
    for logger_name in ['uvicorn', 'uvicorn.error', 'uvicorn.access']:
        uvicorn_logger = logging.getLogger(logger_name)
        # Remove existing handlers and add our own with proper formatting
        uvicorn_logger.handlers.clear()
        handler = logging.StreamHandler(sys.stderr)
        handler.setFormatter(logging.Formatter(LOG_FORMAT, datefmt=DATE_FORMAT))
        uvicorn_logger.addHandler(handler)
        uvicorn_logger.propagate = False
```

该函数在启动MCP服务器时被调用，确保Uvicorn日志与主日志格式一致。

**Section sources**
- [graphiti_mcp_server.py](file://mcp_server/src/graphiti_mcp_server.py#L98-L108)

## Docker部署中的日志持久化
在Docker部署中，MCP服务器的日志通过挂载`mcp_logs`卷进行持久化。`docker-compose.yml`文件中定义了`mcp_logs`卷，并将其挂载到容器内的`/var/log/graphiti`目录。

```yaml
volumes:
  mcp_logs:
    driver: local
```

```yaml
volumes:
  - mcp_logs:/var/log/graphiti
```

日志级别通过环境变量`LOG_LEVEL`进行控制，允许在不修改代码的情况下调整日志的详细程度。

**Section sources**
- [docker-compose.yml](file://mcp_server/docker/docker-compose.yml#L43-L45)
- [Dockerfile](file://mcp_server/docker/Dockerfile#L67)

## 集中式日志收集建议
建议使用ELK栈（Elasticsearch, Logstash, Kibana）或Fluentd进行集中式日志收集。这些工具可以从多个MCP服务器实例收集日志，进行集中存储、搜索和可视化。

日志解析示例：
```json
{
  "timestamp": "2023-04-01T12:00:00Z",
  "level": "INFO",
  "module": "graphiti_mcp_server",
  "message": "Starting MCP server with transport: http"
}
```

**Section sources**
- [graphiti_mcp_server.py](file://mcp_server/src/graphiti_mcp_server.py#L914)

## 结论
MCP服务器的日志管理方案通过结构化的日志格式、Uvicorn日志处理器的重写、Docker部署中的日志持久化策略以及集中式日志收集的集成建议，确保了日志的一致性、可读性和可维护性。