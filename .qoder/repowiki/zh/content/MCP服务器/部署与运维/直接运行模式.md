# 直接运行模式

<cite>
**本文档中引用的文件**  
- [main.py](file://mcp_server/main.py)
- [graphiti_mcp_server.py](file://mcp_server/src/graphiti_mcp_server.py)
- [config.yaml](file://mcp_server/config/config.yaml)
- [.env.example](file://mcp_server/.env.example)
- [pyproject.toml](file://mcp_server/pyproject.toml)
- [schema.py](file://mcp_server/src/config/schema.py)
- [factories.py](file://mcp_server/src/services/factories.py)
- [README.md](file://mcp_server/README.md)
</cite>

## 目录
1. [简介](#简介)
2. [依赖安装](#依赖安装)
3. [环境变量配置](#环境变量配置)
4. [配置文件详解](#配置文件详解)
5. [启动流程与命令行参数](#启动流程与命令行参数)
6. [跨操作系统运行示例](#跨操作系统运行示例)
7. [进程守护与后台运行](#进程守护与后台运行)
8. [日志重定向](#日志重定向)

## 简介

本文档提供在非容器化环境中直接运行MCP服务器的完整指南。重点介绍如何通过Python脚本启动服务器，涵盖依赖管理、环境配置、配置文件加载、启动流程和跨平台运行实践。

**Section sources**
- [README.md](file://mcp_server/README.md#L1-L684)

## 依赖安装

MCP服务器使用`uv`作为包管理器，提供快速、确定性的依赖安装。首先安装`uv`，然后同步项目依赖。

```bash
# 安装uv包管理器
curl -LsSf https://astral.sh/uv/install.sh | sh

# 安装核心依赖
uv sync

# 安装可选依赖（LLM提供商）
uv sync --extra providers
```

`pyproject.toml`文件定义了项目依赖，包括MCP协议、OpenAI客户端、Graphiti核心库和配置管理组件。

```toml
[project]
name = "mcp-server"
version = "1.0.1"
dependencies = [
    "mcp>=1.9.4",
    "openai>=1.91.0",
    "graphiti-core[falkordb]>=0.23.1",
    "pydantic-settings>=2.0.0",
    "pyyaml>=6.0",
    "typing-extensions>=4.0.0",
]
```

**Section sources**
- [pyproject.toml](file://mcp_server/pyproject.toml#L1-L77)
- [README.md](file://mcp_server/README.md#L87-L99)

## 环境变量配置

通过`.env`文件配置环境变量，服务器会自动加载。创建`.env`文件并设置必要的API密钥和数据库连接信息。

```bash
# 复制示例文件
cp .env.example .env

# 编辑.env文件
nano .env
```

关键环境变量包括：

- `OPENAI_API_KEY`: OpenAI API密钥
- `NEO4J_URI`: Neo4j数据库URI
- `NEO4J_USER`: Neo4j用户名
- `NEO4J_PASSWORD`: Neo4j密码
- `SEMAPHORE_LIMIT`: 并发处理限制（默认10）

环境变量支持在`config.yaml`中通过`${VAR_NAME}`语法引用。

**Section sources**
- [.env.example](file://mcp_server/.env.example#L1-L50)
- [README.md](file://mcp_server/README.md#L222-L241)

## 配置文件详解

`config.yaml`是主要的配置文件，支持环境变量扩展和分层配置。文件结构包含服务器、LLM、嵌入器、数据库和应用配置。

```yaml
server:
  transport: "http"
  host: "0.0.0.0"
  port: 8000

llm:
  provider: "openai"
  model: "gpt-5-mini"
  providers:
    openai:
      api_key: ${OPENAI_API_KEY}

database:
  provider: "falkordb"
  providers:
    falkordb:
      uri: ${FALKORDB_URI:redis://localhost:6379}
```

配置文件支持多种数据库（FalkorDB、Neo4j）和LLM提供商（OpenAI、Anthropic、Gemini等）。

**Section sources**
- [config.yaml](file://mcp_server/config/config.yaml#L1-L111)
- [schema.py](file://mcp_server/src/config/schema.py#L76-L292)

## 启动流程与命令行参数

服务器启动流程由`main.py`和`graphiti_mcp_server.py`协同完成。`main.py`是兼容性包装器，导入并运行`graphiti_mcp_server.py`中的`main`函数。

```python
# main.py
if __name__ == '__main__':
    from graphiti_mcp_server import main
    main()
```

`graphiti_mcp_server.py`中的`initialize_server`函数解析命令行参数并初始化配置：

```python
def initialize_server() -> ServerConfig:
    parser = argparse.ArgumentParser()
    parser.add_argument('--config', type=Path, help='配置文件路径')
    parser.add_argument('--transport', choices=['sse', 'stdio', 'http'])
    parser.add_argument('--llm-provider', choices=['openai', 'anthropic', 'gemini'])
    # ... 其他参数
```

可用命令行参数：
- `--config`: YAML配置文件路径
- `--transport`: 传输方式（http、stdio）
- `--llm-provider`: LLM提供商
- `--database-provider`: 数据库提供商
- `--group-id`: 图命名空间
- `--destroy-graph`: 启动时清除图数据

**Section sources**
- [main.py](file://mcp_server/main.py#L1-L27)
- [graphiti_mcp_server.py](file://mcp_server/src/graphiti_mcp_server.py#L762-L966)
- [schema.py](file://mcp_server/src/config/schema.py#L263-L292)

## 跨操作系统运行示例

### Linux/macOS

```bash
# 设置环境变量
export OPENAI_API_KEY=your_api_key_here
export NEO4J_PASSWORD=your_password_here

# 启动服务器
uv run graphiti_mcp_server.py --config config/config.yaml --transport http

# 后台运行
uv run graphiti_mcp_server.py &

# 使用nohup后台运行
nohup uv run graphiti_mcp_server.py > mcp_server.log 2>&1 &
```

### Windows

```cmd
:: 设置环境变量
set OPENAI_API_KEY=your_api_key_here
set NEO4J_PASSWORD=your_password_here

:: 启动服务器
uv run graphiti_mcp_server.py --config config\config.yaml --transport http

:: 后台运行（使用start命令）
start /B uv run graphiti_mcp_server.py
```

使用`uv`运行时，可通过`--isolated`标志确保环境隔离：

```bash
uv run --isolated --directory /path/to/mcp_server graphiti_mcp_server.py
```

**Section sources**
- [README.md](file://mcp_server/README.md#L276-L289)
- [graphiti_mcp_server.py](file://mcp_server/src/graphiti_mcp_server.py#L908-L966)

## 进程守护与后台运行

为确保服务器稳定运行，建议使用进程守护工具。

### 使用systemd（Linux）

创建systemd服务文件：

```ini
[Unit]
Description=Graphiti MCP Server
After=network.target

[Service]
Type=simple
User=graphiti
WorkingDirectory=/opt/graphiti/mcp_server
ExecStart=/usr/local/bin/uv run graphiti_mcp_server.py
Restart=always
Environment=OPENAI_API_KEY=your_key_here

[Install]
WantedBy=multi-user.target
```

### 使用pm2（跨平台）

```bash
# 安装pm2
npm install -g pm2

# 启动服务器
pm2 start "uv run graphiti_mcp_server.py" --name "mcp-server"

# 设置开机自启
pm2 startup
pm2 save
```

### 使用screen/tmux

```bash
# 使用screen
screen -S mcp-server
uv run graphiti_mcp_server.py
# 按Ctrl+A, D分离会话

# 使用tmux
tmux new-session -d -s mcp-server 'uv run graphiti_mcp_server.py'
```

**Section sources**
- [README.md](file://mcp_server/README.md#L447-L452)
- [graphiti_mcp_server.py](file://mcp_server/src/graphiti_mcp_server.py#L914-L949)

## 日志重定向

服务器使用结构化日志记录，可通过多种方式重定向日志输出。

### 文件重定向

```bash
# 重定向到日志文件
uv run graphiti_mcp_server.py > mcp_server.log 2>&1

# 按日期轮转日志
uv run graphiti_mcp_server.py | tee -a mcp_server_$(date +%Y%m%d).log
```

### 日志级别控制

通过环境变量控制日志级别：

```bash
# 设置日志级别
export LOG_LEVEL=INFO
export LOG_FORMAT='%(asctime)s - %(name)s - %(levelname)s - %(message)s'
```

在代码中配置日志：

```python
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S',
    stream=sys.stderr,
)
```

### 日志监控

使用`tail`实时监控日志：

```bash
# 实时查看日志
tail -f mcp_server.log

# 查看最后100行
tail -100 mcp_server.log

# 搜索错误日志
grep "ERROR" mcp_server.log
```

**Section sources**
- [graphiti_mcp_server.py](file://mcp_server/src/graphiti_mcp_server.py#L78-L95)
- [README.md](file://mcp_server/README.md#L447-L452)