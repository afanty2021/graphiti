# 节点过滤器构造逻辑

<cite>
**本文档中引用的文件**   
- [search_filters.py](file://graphiti_core/search/search_filters.py)
- [search_utils.py](file://graphiti_core/search/search_utils.py)
- [driver.py](file://graphiti_core/driver/driver.py)
- [graph_queries.py](file://graphiti_core/graph_queries.py)
</cite>

## 目录
1. [简介](#简介)
2. [节点标签过滤查询构造](#节点标签过滤查询构造)
3. [filter_params参数的安全机制](#filter_params参数的安全机制)
4. [不同GraphProvider的查询条件生成](#不同graphprovider的查询条件生成)
5. [查询片段的集成方式](#查询片段的集成方式)
6. [实际代码示例](#实际代码示例)

## 简介
`node_search_filter_query_constructor`函数是graphiti项目中用于根据`SearchFilters`中的`node_labels`字段生成Cypher查询片段的核心组件。该函数负责将高级别的搜索过滤条件转换为底层图数据库查询语言的具体实现，同时确保查询的安全性和跨不同图数据库提供商的兼容性。

## 节点标签过滤查询构造
`node_search_filter_query_constructor`函数根据`SearchFilters`对象中的`node_labels`字段生成相应的Cypher查询片段。当`node_labels`不为空时，函数会根据不同的`GraphProvider`生成不同的查询条件。对于Kuzu数据库，使用`list_has_all(n.labels, $labels)`函数来检查节点标签是否包含所有指定的标签；对于其他数据库，使用`n:label1|label2`的语法来匹配任意一个标签。

**Section sources**
- [search_filters.py](file://graphiti_core/search/search_filters.py#L68-L84)

## filter_params参数的安全机制
`filter_params`参数在防止注入攻击方面起着关键作用。通过将用户输入的标签值作为参数传递，而不是直接拼接到查询字符串中，可以有效防止Cypher注入攻击。参数化查询确保了用户输入的数据被正确地转义和处理，从而保护了数据库的安全。

**Section sources**
- [search_filters.py](file://graphiti_core/search/search_filters.py#L72-L73)

## 不同GraphProvider的查询条件生成
当`node_labels`不为空时，`node_search_filter_query_constructor`函数会根据`GraphProvider`的不同生成不同的查询条件。对于Kuzu，使用`list_has_all`函数；对于Neo4j、FalkorDB等，使用标签匹配语法。这种设计允许函数适应不同图数据库的特性和语法要求。

**Section sources**
- [search_filters.py](file://graphiti_core/search/search_filters.py#L76-L82)
- [driver.py](file://graphiti_core/driver/driver.py#L42-L46)

## 查询片段的集成方式
生成的查询片段通过`node_fulltext_search`、`node_similarity_search`和`node_bfs_search`等函数集成到最终的Cypher语句中。这些函数首先调用`node_search_filter_query_constructor`获取过滤条件，然后将其与其他查询条件组合，形成完整的查询语句。这种方式确保了过滤逻辑的一致性和可维护性。

**Section sources**
- [search_utils.py](file://graphiti_core/search/search_utils.py#L573-L583)
- [search_utils.py](file://graphiti_core/search/search_utils.py#L662-L672)
- [search_utils.py](file://graphiti_core/search/search_utils.py#L778-L789)

## 实际代码示例
以下示例展示了在多种标签过滤场景下`node_search_filter_query_constructor`的行为。当`node_labels`包含多个标签时，函数会生成相应的查询条件，以确保只有同时具有这些标签的节点才会被返回。此外，通过使用`filter_params`，可以安全地传递标签值，避免注入风险。

**Section sources**
- [search_filters.py](file://graphiti_core/search/search_filters.py#L75-L82)
- [search_utils.py](file://graphiti_core/search/search_utils.py#L573-L583)