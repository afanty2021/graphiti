# 检索结果处理

<cite>
**本文档引用的文件**   
- [search.py](file://graphiti_core/search/search.py)
- [search_config.py](file://graphiti_core/search/search_config.py)
- [search_utils.py](file://graphiti_core/search/search_utils.py)
- [node_db_queries.py](file://graphiti_core/models/nodes/node_db_queries.py)
- [edge_db_queries.py](file://graphiti_core/models/edges/edge_db_queries.py)
- [search_helpers.py](file://graphiti_core/search/search_helpers.py)
</cite>

## 目录
1. [简介](#简介)
2. [SearchResults数据模型](#searchresults数据模型)
3. [片段生成](#片段生成)
4. [结果去重、排序与截断](#结果去重排序与截断)
5. [多源结果整合与评分](#多源结果整合与评分)
6. [结果质量评估与调试](#结果质量评估与调试)
7. [结果呈现优化](#结果呈现优化)

## 简介
Graphiti系统提供了一套完整的检索结果后处理流程，用于处理从图数据库中检索出的节点、边、事件和社区等多源信息。该流程包括结果的合并、去重、排序、评分和呈现等多个环节，确保最终返回给用户的结果既全面又相关。

## SearchResults数据模型
`SearchResults` 数据模型是检索结果的核心容器，用于存储和管理从图数据库中检索出的各种实体。该模型定义了检索结果的结构，包括边、节点、事件和社区等不同类型的实体及其对应的重排序分数。

`SearchResults` 类提供了 `merge` 方法，用于将多个 `SearchResults` 对象合并成一个单一的对象。该方法通过将输入结果列表中的所有结果合并到一个新的 `SearchResults` 对象中来实现。如果输入结果列表为空，则返回一个空的 `SearchResults` 对象。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L121-L160)

## 片段生成
片段生成是从原始内容中提取相关上下文的过程。在Graphiti系统中，片段生成主要通过 `search_results_to_context_string` 函数实现。该函数将 `SearchResults` 对象转换为一个字符串，以便直接传递给语言模型作为上下文。

该函数首先将检索结果中的事实、实体、事件和社区等信息转换为JSON格式，然后将这些JSON数据嵌入到一个预定义的模板字符串中。模板字符串包含了对不同类型信息的描述，如事实的有效期、实体的摘要等。最终生成的字符串可以作为语言模型的输入，帮助模型更好地理解检索结果的上下文。

**Section sources**
- [search_helpers.py](file://graphiti_core/search/search_helpers.py#L27-L72)

## 结果去重、排序与截断
检索结果的去重、排序和截断是确保结果质量和效率的关键步骤。Graphiti系统通过多种重排序算法来实现这些功能。

### 去重
去重主要通过 `rrf`（Reciprocal Rank Fusion）算法实现。该算法将多个排序列表中的结果进行融合，通过计算每个结果的倒数排名得分来确定其最终排名。得分低于指定阈值的结果将被过滤掉。

### 排序
排序算法包括 `rrf`、`mmr`（Maximal Marginal Relevance）、`cross_encoder` 和 `node_distance` 等。`rrf` 用于融合多个排序列表，`mmr` 用于最大化结果的多样性和相关性，`cross_encoder` 用于使用交叉编码器模型对结果进行重排序，`node_distance` 用于根据节点之间的图距离对结果进行重排序。

### 截断
截断通过设置 `limit` 参数来实现。该参数指定了返回结果的最大数量。在重排序后，结果列表将被截断到指定长度。

**Section sources**
- [search_utils.py](file://graphiti_core/search/search_utils.py#L1733-L1876)
- [search.py](file://graphiti_core/search/search.py#L255-L306)

## 多源结果整合与评分
Graphiti系统支持从多个来源（节点、边、事件、社区）检索结果，并通过配置化的搜索方法和重排序策略进行整合与评分。

### 搜索方法
搜索方法包括 `bm25`（全文搜索）、`cosine_similarity`（余弦相似度搜索）和 `bfs`（广度优先搜索）。这些方法可以单独使用，也可以组合使用以实现混合搜索。

### 重排序策略
重排序策略包括 `rrf`、`mmr`、`cross_encoder` 和 `node_distance` 等。这些策略可以根据具体的应用场景进行选择和配置。

### 配置化搜索
通过 `SearchConfig` 类，可以配置不同类型的搜索方法和重排序策略。例如，`COMBINED_HYBRID_SEARCH_RRF` 配置了对边、节点和社区的混合搜索，并使用 `rrf` 进行重排序。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L32-L119)
- [search_config_recipes.py](file://graphiti_core/search/search_config_recipes.py#L34-L223)
- [search.py](file://graphiti_core/search/search.py#L118-L166)

## 结果质量评估与调试
结果质量评估和调试是确保检索系统性能的重要环节。Graphiti系统提供了多种工具和方法来评估和调试检索结果。

### 调试技巧
- **日志记录**：通过日志记录检索过程中的关键信息，如查询时间、结果数量等。
- **性能监控**：监控检索过程的性能指标，如响应时间、资源消耗等。
- **结果验证**：通过手动验证检索结果的准确性和相关性。

### 评估方法
- **相关性评估**：评估检索结果与查询的相关性。
- **多样性评估**：评估检索结果的多样性，避免结果过于集中。
- **覆盖率评估**：评估检索结果的覆盖率，确保重要信息不被遗漏。

**Section sources**
- [search.py](file://graphiti_core/search/search.py#L179-L181)
- [search_utils.py](file://graphiti_core/search/search_utils.py#L1201-L1202)

## 结果呈现优化
根据不同的应用场景，可以对检索结果的呈现方式进行优化，以提高用户体验。

### 优化策略
- **上下文呈现**：将检索结果以自然语言的形式呈现，帮助用户更好地理解结果的上下文。
- **可视化呈现**：通过图表或图形化界面展示检索结果，使结果更加直观。
- **个性化呈现**：根据用户的偏好和历史行为，个性化地呈现检索结果。

### 应用场景
- **问答系统**：在问答系统中，检索结果可以直接作为答案的上下文。
- **推荐系统**：在推荐系统中，检索结果可以作为推荐的依据。
- **知识图谱**：在知识图谱中，检索结果可以用于构建和更新图谱。

**Section sources**
- [search_helpers.py](file://graphiti_core/search/search_helpers.py#L27-L72)
- [search.py](file://graphiti_core/search/search.py#L168-L177)