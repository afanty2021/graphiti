# 检索配置概述

<cite>
**本文档中引用的文件**  
- [search_config.py](file://graphiti_core/search/search_config.py)
- [search_config_recipes.py](file://graphiti_core/search/search_config_recipes.py)
- [search.py](file://graphiti_core/search/search.py)
- [graphiti.py](file://graphiti_core/graphiti.py)
- [search_utils.py](file://graphiti_core/search/search_utils.py)
</cite>

## 目录
1. [简介](#简介)
2. [SearchConfig类结构](#searchconfig类结构)
3. [核心配置字段详解](#核心配置字段详解)
4. [预定义配置配方](#预定义配置配方)
5. [检索结果合并机制](#检索结果合并机制)
6. [在Graphiti核心流程中的集成](#在graphiti核心流程中的集成)
7. [配置继承与覆盖](#配置继承与覆盖)
8. [实际应用示例](#实际应用示例)

## 简介
SearchConfig类是Graphiti检索系统的核心配置容器，负责协调节点、边、片段和社区的检索行为。该类通过结构化的配置参数，为不同类型的图元素提供灵活的搜索策略和排序机制。SearchConfig作为检索流程的控制中心，允许开发者根据具体应用场景定制搜索行为，包括选择搜索方法、配置重排序算法以及设置检索限制等参数。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L112-L119)

## SearchConfig类结构
SearchConfig类是一个基于Pydantic的配置模型，包含多个嵌套的配置类，用于控制不同图元素的检索行为。该类通过组合不同的搜索配置，实现了对图数据的精细化检索控制。

```mermaid
classDiagram
class SearchConfig {
+edge_config : EdgeSearchConfig | None
+node_config : NodeSearchConfig | None
+episode_config : EpisodeSearchConfig | None
+community_config : CommunitySearchConfig | None
+limit : int
+reranker_min_score : float
}
class EdgeSearchConfig {
+search_methods : list[EdgeSearchMethod]
+reranker : EdgeReranker
+sim_min_score : float
+mmr_lambda : float
+bfs_max_depth : int
}
class NodeSearchConfig {
+search_methods : list[NodeSearchMethod]
+reranker : NodeReranker
+sim_min_score : float
+mmr_lambda : float
+bfs_max_depth : int
}
class EpisodeSearchConfig {
+search_methods : list[EpisodeSearchMethod]
+reranker : EpisodeReranker
+sim_min_score : float
+mmr_lambda : float
+bfs_max_depth : int
}
class CommunitySearchConfig {
+search_methods : list[CommunitySearchMethod]
+reranker : CommunityReranker
+sim_min_score : float
+mmr_lambda : float
+bfs_max_depth : int
}
SearchConfig --> EdgeSearchConfig : "包含"
SearchConfig --> NodeSearchConfig : "包含"
SearchConfig --> EpisodeSearchConfig : "包含"
SearchConfig --> CommunitySearchConfig : "包含"
```

**Diagram sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L80-L119)

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L80-L119)

## 核心配置字段详解
SearchConfig类通过一系列字段来定义检索行为，每个字段都有明确的语义含义和默认值。

### 主要配置字段
| 字段 | 类型 | 默认值 | 语义含义 |
|------|------|--------|--------|
| edge_config | EdgeSearchConfig | None | 边的检索配置 |
| node_config | NodeSearchConfig | None | 节点的检索配置 |
| episode_config | EpisodeSearchConfig | None | 片段的检索配置 |
| community_config | CommunitySearchConfig | None | 社区的检索配置 |
| limit | int | 10 | 检索结果的最大数量 |
| reranker_min_score | float | 0 | 重排序器的最小分数阈值 |

### 搜索方法枚举
系统定义了多种搜索方法，用于不同类型的图元素：

```mermaid
classDiagram
class EdgeSearchMethod {
+cosine_similarity
+bm25
+bfs
}
class NodeSearchMethod {
+cosine_similarity
+bm25
+bfs
}
class EpisodeSearchMethod {
+bm25
}
class CommunitySearchMethod {
+cosine_similarity
+bm25
}
```

**Diagram sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L32-L51)

### 重排序器枚举
系统提供了多种重排序算法，用于优化检索结果的排序：

```mermaid
classDiagram
class EdgeReranker {
+rrf
+node_distance
+episode_mentions
+mmr
+cross_encoder
}
class NodeReranker {
+rrf
+node_distance
+episode_mentions
+mmr
+cross_encoder
}
class EpisodeReranker {
+rrf
+cross_encoder
}
class CommunityReranker {
+rrf
+mmr
+cross_encoder
}
```

**Diagram sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L53-L78)

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L32-L78)

## 预定义配置配方
系统提供了一系列预定义的配置配方，这些配方是经过优化的SearchConfig实例，适用于常见的检索场景。

### 配方类型
```mermaid
graph TD
A[预定义配置配方] --> B[COMBINED_HYBRID_SEARCH_RRF]
A --> C[COMBINED_HYBRID_SEARCH_MMR]
A --> D[COMBINED_HYBRID_SEARCH_CROSS_ENCODER]
A --> E[EDGE_HYBRID_SEARCH_RRF]
A --> F[NODE_HYBRID_SEARCH_RRF]
A --> G[COMMUNITY_HYBRID_SEARCH_RRF]
B --> H["边、节点、片段、社区的混合搜索<br/>使用RRF重排序"]
C --> I["边、节点、片段、社区的混合搜索<br/>使用MMR重排序"]
D --> J["边、节点、片段、社区的混合搜索<br/>使用交叉编码器重排序"]
E --> K["边的混合搜索<br/>使用RRF重排序"]
F --> L["节点的混合搜索<br/>使用RRF重排序"]
G --> M["社区的混合搜索<br/>使用RRF重排序"]
```

**Diagram sources**
- [search_config_recipes.py](file://graphiti_core/search/search_config_recipes.py#L34-L223)

### 配方配置细节
| 配方名称 | 搜索方法 | 重排序器 | 适用场景 |
|---------|---------|---------|---------|
| COMBINED_HYBRID_SEARCH_RRF | BM25 + 余弦相似度 | RRF | 通用混合搜索 |
| COMBINED_HYBRID_SEARCH_MMR | BM25 + 余弦相似度 | MMR | 需要多样性结果的搜索 |
| COMBINED_HYBRID_SEARCH_CROSS_ENCODER | BM25 + 余弦相似度 + BFS | 交叉编码器 | 高精度语义搜索 |
| EDGE_HYBRID_SEARCH_RRF | BM25 + 余弦相似度 | RRF | 边的混合搜索 |
| NODE_HYBRID_SEARCH_RRF | BM25 + 余弦相似度 | RRF | 节点的混合搜索 |

**Section sources**
- [search_config_recipes.py](file://graphiti_core/search/search_config_recipes.py#L34-L223)

## 检索结果合并机制
SearchResults类提供了合并多个检索结果的功能，这对于分布式搜索或分阶段搜索场景非常重要。

### SearchResults类结构
```mermaid
classDiagram
class SearchResults {
+edges : list[EntityEdge]
+edge_reranker_scores : list[float]
+nodes : list[EntityNode]
+node_reranker_scores : list[float]
+episodes : list[EpisodicNode]
+episode_reranker_scores : list[float]
+communities : list[CommunityNode]
+community_reranker_scores : list[float]
+merge(results_list : list[SearchResults]) SearchResults
}
```

**Diagram sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L121-L160)

### 合并流程
```mermaid
flowchart TD
Start([开始]) --> CheckEmpty{"结果列表为空?"}
CheckEmpty --> |是| ReturnEmpty[返回空结果]
CheckEmpty --> |否| Initialize[初始化合并结果]
Initialize --> LoopStart[遍历结果列表]
LoopStart --> GetResult[获取单个结果]
GetResult --> MergeEdges[合并边和分数]
MergeEdges --> MergeNodes[合并节点和分数]
MergeNodes --> MergeEpisodes[合并片段和分数]
MergeEpisodes --> MergeCommunities[合并社区和分数]
MergeCommunities --> LoopEnd{是否还有结果?}
LoopEnd --> |是| LoopStart
LoopEnd --> |否| ReturnMerged[返回合并结果]
```

**Diagram sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L131-L159)

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L121-L160)

## 在Graphiti核心流程中的集成
SearchConfig在Graphiti的核心检索流程中扮演着关键角色，它被传递给search函数以控制整个检索过程。

### 核心检索流程
```mermaid
sequenceDiagram
participant Client as "客户端"
participant Graphiti as "Graphiti"
participant Search as "search函数"
participant Driver as "图数据库驱动"
Client->>Graphiti : 发起搜索请求
Graphiti->>Search : 调用search函数
activate Search
Search->>Search : 验证查询和配置
Search->>Search : 生成查询向量
Search->>Driver : 并行执行边搜索
Search->>Driver : 并行执行节点搜索
Search->>Driver : 并行执行片段搜索
Search->>Driver : 并行执行社区搜索
Driver-->>Search : 返回搜索结果
Search->>Search : 合并所有结果
Search-->>Graphiti : 返回合并的SearchResults
deactivate Search
Graphiti-->>Client : 返回最终结果
```

**Diagram sources**
- [search.py](file://graphiti_core/search/search.py#L68-L183)
- [graphiti.py](file://graphiti_core/graphiti.py#L245-L277)

### 搜索方法执行逻辑
```mermaid
flowchart TD
Start([开始]) --> CheckConfig{"配置存在?"}
CheckConfig --> |否| ReturnEmpty[返回空结果]
CheckConfig --> |是| BuildTasks[构建搜索任务]
BuildTasks --> HasBM25{"包含BM25方法?"}
HasBM25 --> |是| AddBM25Task[添加全文搜索任务]
HasBM25 --> |否| CheckSimilarity
CheckSimilarity{"包含余弦相似度方法?"}
CheckSimilarity --> |是| AddSimilarityTask[添加相似度搜索任务]
CheckSimilarity --> |否| CheckBFS
CheckBFS{"包含BFS方法?"}
CheckBFS --> |是| AddBFSTask[添加BFS搜索任务]
CheckBFS --> |否| ExecuteTasks
AddBM25Task --> CheckSimilarity
AddSimilarityTask --> CheckBFS
AddBFSTask --> ExecuteTasks
ExecuteTasks --> RunTasks[执行所有任务]
RunTasks --> GetResults[获取搜索结果]
GetResults --> ApplyReranker[应用重排序器]
ApplyReranker --> ReturnResults[返回结果]
```

**Diagram sources**
- [search.py](file://graphiti_core/search/search.py#L186-L306)

**Section sources**
- [search.py](file://graphiti_core/search/search.py#L68-L306)

## 配置继承与覆盖
SearchConfig支持配置的继承和覆盖机制，允许在预定义配方的基础上进行定制化修改。

### 配置继承示例
```mermaid
graph TD
Base[基础配置] --> |继承| Custom[自定义配置]
Custom --> ModifyLimit[修改limit值]
Custom --> ModifyReranker[修改重排序器]
Custom --> AddSearchMethod[添加搜索方法]
ModifyLimit --> Final[最终配置]
ModifyReranker --> Final
AddSearchMethod --> Final
```

**Diagram sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L112-L119)
- [search_config_recipes.py](file://graphiti_core/search/search_config_recipes.py#L34-L223)

### 配置覆盖机制
系统通过Pydantic的model_copy方法实现配置的深拷贝和覆盖，确保原始配置配方不会被修改。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L112-L119)
- [search_config_recipes.py](file://graphiti_core/search/search_config_recipes.py#L34-L223)

## 实际应用示例
以下是在实际应用中使用SearchConfig的典型场景。

### 自定义搜索配置
```python
# 从预定义配方创建自定义配置
custom_config = NODE_HYBRID_SEARCH_RRF.model_copy(deep=True)
custom_config.limit = 5
custom_config.node_config.reranker = NodeReranker.mmr
```

### 在Graphiti中使用自定义配置
```python
# 使用自定义配置进行搜索
results = await graphiti._search(
    query='California Governor',
    config=custom_config,
)
```

**Section sources**
- [quickstart_neo4j.py](file://examples/quickstart/quickstart_neo4j.py#L28-L208)
- [search_config.py](file://graphiti_core/search/search_config.py#L112-L119)