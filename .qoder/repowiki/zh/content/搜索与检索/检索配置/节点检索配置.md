# 节点检索配置

<cite>
**本文档中引用的文件**  
- [search_config.py](file://graphiti_core/search/search_config.py)
- [search_config_recipes.py](file://graphiti_core/search/search_config_recipes.py)
- [search.py](file://graphiti_core/search/search.py)
- [search_utils.py](file://graphiti_core/search/search_utils.py)
</cite>

## 目录
1. [简介](#简介)
2. [NodeSearchConfig字段详解](#nodesearchconfig字段详解)
3. [检索方法分析](#检索方法分析)
4. [重排序策略分析](#重排序策略分析)
5. [实际配置示例](#实际配置示例)
6. [NodeReranker枚举类型实现逻辑](#nodereranker枚举类型实现逻辑)

## 简介
本文档深入探讨NodeSearchConfig的详细配置，涵盖其所有字段和功能。NodeSearchConfig是图数据库检索系统中的核心配置类，用于定义节点检索的行为和策略。该配置支持多种检索方法和重排序策略，能够满足不同场景下的检索需求。通过合理配置这些参数，可以优化检索结果的相关性和性能表现。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L88-L94)

## NodeSearchConfig字段详解
NodeSearchConfig类定义了节点检索的配置参数，包含以下关键字段：

- **search_methods**：检索方法列表，支持cosine_similarity、bm25和bfs三种方法
- **reranker**：重排序策略，决定检索结果的最终排序方式
- **sim_min_score**：相似度最小分数阈值，用于过滤低相关性结果
- **mmr_lambda**：MMR算法的λ参数，控制相关性和多样性的平衡
- **bfs_max_depth**：BFS搜索的最大深度，限制图遍历的范围

这些字段共同决定了节点检索的行为和结果质量。配置中的每个参数都有默认值，但可以根据具体需求进行调整以优化检索效果。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L88-L94)

## 检索方法分析
NodeSearchConfig支持三种主要的检索方法，每种方法适用于不同的使用场景：

### 语义相似度检索（cosine_similarity）
基于向量嵌入的余弦相似度进行检索，适用于需要理解查询语义的场景。该方法将查询和节点内容转换为向量，通过计算向量间的余弦相似度来评估相关性。适合处理自然语言查询和语义搜索。

### 关键词匹配检索（bm25）
基于BM25算法的全文检索方法，适用于精确关键词匹配的场景。该方法对文本中的关键词频率和文档长度进行加权，能够有效识别包含特定关键词的节点。适合处理结构化查询和关键词搜索。

### 图遍历检索（bfs）
基于广度优先搜索的图遍历方法，适用于需要探索节点关系网络的场景。该方法从指定节点出发，按照BFS算法遍历图结构，发现与起始节点相关的其他节点。适合处理关系发现和路径探索。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L38-L41)
- [search.py](file://graphiti_core/search/search.py#L327-L352)

## 重排序策略分析
NodeSearchConfig提供了多种重排序策略，用于优化检索结果的排序：

### 互逆排名融合（rrf）
将多个检索结果列表进行融合排序，通过计算每个结果在各个列表中的排名来确定最终得分。该策略能够综合不同检索方法的优势，提高结果的整体质量。

### 节点距离重排序（node_distance）
基于节点间图距离的重排序策略，优先返回与中心节点距离较近的结果。该策略适用于需要发现与特定节点紧密相关实体的场景。

### 情节提及重排序（episode_mentions）
根据节点在情节中的提及次数进行排序，优先返回被频繁提及的节点。该策略适用于发现重要或热门实体。

### 最大边际相关性（mmr）
平衡结果相关性和多样性的重排序策略，通过λ参数控制两者之间的权衡。当λ接近1时偏向相关性，接近0时偏向多样性。

### 交叉编码器重排序（cross_encoder）
使用交叉编码器模型对查询和结果进行联合编码，计算更精确的相关性得分。该策略通常能提供最准确的排序，但计算成本较高。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L61-L67)
- [search.py](file://graphiti_core/search/search.py#L375-L416)

## 实际配置示例
以下是几种常见的NodeSearchConfig配置示例：

### 混合语义与关键词搜索
```python
NodeSearchConfig(
    search_methods=[NodeSearchMethod.bm25, NodeSearchMethod.cosine_similarity],
    reranker=NodeReranker.rrf
)
```
此配置结合了关键词匹配和语义相似度两种检索方法，并使用RRF进行结果融合，能够同时兼顾精确匹配和语义理解。

### 使用MMR减少冗余结果
```python
NodeSearchConfig(
    search_methods=[NodeSearchMethod.bm25, NodeSearchMethod.cosine_similarity],
    reranker=NodeReranker.mmr,
    mmr_lambda=0.7
)
```
此配置使用MMR重排序策略，通过调整mmr_lambda参数来平衡结果的相关性和多样性，有效减少冗余结果。

### 通过BFS进行图遍历
```python
NodeSearchConfig(
    search_methods=[NodeSearchMethod.bfs],
    bfs_max_depth=2
)
```
此配置专注于图遍历检索，设置最大深度为2，适合探索节点的直接和间接关系。

**Section sources**
- [search_config_recipes.py](file://graphiti_core/search/search_config_recipes.py#L156-L198)

## NodeReranker枚举类型实现逻辑
NodeReranker枚举类型定义了节点检索的重排序策略，其内部实现逻辑如下：

### RRF实现
RRF（Reciprocal Rank Fusion）通过将不同检索方法的结果进行融合，为每个结果计算综合得分。得分计算公式为Σ(1/(rank + constant))，其中rank是结果在各个列表中的排名。

### MMR实现
MMR（Maximal Marginal Relevance）算法通过以下公式计算得分：MMR = λ * similarity(query, result) - (1-λ) * max(similarity(result, selected_results))。该算法在保持结果相关性的同时，最大化结果间的差异性。

### Cross Encoder实现
交叉编码器重排序使用专门的模型对查询和候选结果进行联合编码，计算更精确的相关性得分。该方法通常需要额外的计算资源，但能提供更准确的排序结果。

### Node Distance实现
节点距离重排序首先使用RRF进行初步排序，然后根据节点与中心节点的图距离进行重新排序。距离越近的节点排名越靠前，适用于需要发现紧密相关实体的场景。

### Episode Mentions实现
情节提及重排序根据节点在情节中的提及次数进行排序，提及次数越多的节点排名越前。该策略能够识别出在上下文中更重要的实体。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L61-L67)
- [search_utils.py](file://graphiti_core/search/search_utils.py#L1732-L1876)