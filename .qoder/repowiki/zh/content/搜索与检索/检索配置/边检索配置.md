# 边检索配置

<cite>
**本文档中引用的文件**  
- [search_config.py](file://graphiti_core/search/search_config.py)
- [search_config_recipes.py](file://graphiti_core/search/search_config_recipes.py)
- [search.py](file://graphiti_core/search/search.py)
- [search_utils.py](file://graphiti_core/search/search_utils.py)
</cite>

## 目录
1. [简介](#简介)
2. [EdgeSearchConfig结构分析](#edgesearchconfig结构分析)
3. [检索方法详解](#检索方法详解)
4. [重排序策略对比](#重排序策略对比)
5. [配置示例与优化](#配置示例与优化)
6. [图结构分析关系](#图结构分析关系)
7. [复杂查询中的BFS应用](#复杂查询中的bfs应用)
8. [结论](#结论)

## 简介
边检索配置（EdgeSearchConfig）是图数据检索系统中的核心组件，用于定义边（Edge）的检索行为和重排序策略。该配置支持多种检索方法和重排序算法，能够根据不同的业务需求优化关系查询的精度与多样性。通过合理配置，可以在复杂图结构中实现高效的语义搜索和拓扑分析。

## EdgeSearchConfig结构分析

`EdgeSearchConfig` 类定义了边检索的核心参数，包括检索方法、重排序器以及相关阈值设置。其主要属性如下：

- **search_methods**: 支持的检索方法列表，可组合使用多种方法
- **reranker**: 重排序策略，决定最终结果的排序方式
- **sim_min_score**: 相似度搜索的最小分数阈值
- **mmr_lambda**: MMR算法的多样性控制参数
- **bfs_max_depth**: BFS搜索的最大深度

该配置通过Pydantic模型实现类型安全和默认值管理，确保了配置的可靠性和易用性。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L80-L86)

## 检索方法详解

### 余弦相似度（cosine_similarity）
基于向量嵌入的语义相似度搜索，通过计算查询向量与边事实（fact）向量的余弦相似度来匹配相关边。适用于需要语义理解的场景，能够捕捉到词汇表面之外的深层关联。

### BM25全文搜索（bm25）
基于词频的全文检索方法，对文本中的关键词进行加权匹配。适合精确匹配和关键词搜索，尤其在处理短语查询时表现优异。

### 广度优先搜索（bfs）
基于图拓扑结构的遍历搜索，从指定节点出发按层级扩展。能够发现间接关联的边，适用于探索复杂关系路径和发现隐含连接。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L32-L35)
- [search.py](file://graphiti_core/search/search.py#L204-L231)

## 重排序策略对比

### RRF（reciprocal_rank_fusion）
倒数排名融合算法，将多个检索源的结果进行融合排序。通过综合不同方法的排名，提高整体检索质量，适用于多方法混合检索场景。

### 节点距离（node_distance）
强调拓扑邻近性的重排序策略，优先返回与中心节点距离较近的边。业务意义在于突出直接关联关系，在社交网络分析等场景中能有效识别核心关系。

### 共现频率（episode_mentions）
基于事件共现频率的排序，优先返回在多个上下文中同时出现的边。能够识别出高频协同出现的关系模式，适用于行为分析和模式发现。

### MMR（maximal_marginal_relevance）
最大边际相关性算法，在保持相关性的同时增加结果多样性。通过平衡相似度和差异性，避免返回重复或高度相似的结果。

### 交叉编码器（cross_encoder）
使用深度学习模型对查询和候选边进行联合编码，计算精细化的相关性分数。能够捕捉复杂的语义交互，提供最精确的排序结果。

**Section sources**
- [search_config.py](file://graphiti_core/search/search_config.py#L53-L58)
- [search.py](file://graphiti_core/search/search.py#L255-L306)

## 配置示例与优化

以下配置示例展示了如何优化关系查询的精度与多样性：

```python
# 混合检索配置：结合BM25和余弦相似度，使用RRF重排序
EDGE_HYBRID_SEARCH_RRF = SearchConfig(
    edge_config=EdgeSearchConfig(
        search_methods=[EdgeSearchMethod.bm25, EdgeSearchMethod.cosine_similarity],
        reranker=EdgeReranker.rrf,
    )
)

# 多样性优化配置：使用MMR重排序，lambda值设为1以增强多样性
EDGE_HYBRID_SEARCH_MMR = SearchConfig(
    edge_config=EdgeSearchConfig(
        search_methods=[EdgeSearchMethod.bm25, EdgeSearchMethod.cosine_similarity],
        reranker=EdgeReranker.mmr,
        mmr_lambda=1,
    )
)

# 精度优化配置：使用交叉编码器进行精细化排序
EDGE_HYBRID_SEARCH_CROSS_ENCODER = SearchConfig(
    edge_config=EdgeSearchConfig(
        search_methods=[
            EdgeSearchMethod.bm25,
            EdgeSearchMethod.cosine_similarity,
            EdgeSearchMethod.bfs,
        ],
        reranker=EdgeReranker.cross_encoder,
    ),
    limit=10,
)
```

**Section sources**
- [search_config_recipes.py](file://graphiti_core/search/search_config_recipes.py#L111-L153)

## 图结构分析关系

`EdgeReranker` 与图结构分析密切相关，特别是 `node_distance` 重排序器直接利用了图的拓扑特性。通过计算节点间的最短路径距离，该策略能够：

1. 识别核心节点周围的直接关联
2. 发现社区结构中的关键连接
3. 评估关系的结构性重要性

这种基于图结构的重排序不仅提高了检索的相关性，还为图数据分析提供了有价值的洞察。例如，在社交网络中，距离中心用户较近的关系往往更具影响力。

**Section sources**
- [search.py](file://graphiti_core/search/search.py#L276-L300)
- [search_utils.py](file://graphiti_core/search/search_utils.py#L849-L898)

## 复杂查询中的BFS应用

在复杂查询场景中，BFS（广度优先搜索）扩展了检索范围，能够：

1. **发现间接关联**：通过多跳遍历找到非直接连接的实体关系
2. **构建上下文**：从初始结果出发扩展邻域，丰富查询上下文
3. **探索路径**：识别实体间的连接路径，揭示潜在的关系链

当配置中包含BFS方法且未指定起点时，系统会自动将初步检索结果的源节点作为BFS起点，实现智能扩展。最大搜索深度由`bfs_max_depth`参数控制，防止无限扩展。

**Section sources**
- [search.py](file://graphiti_core/search/search.py#L221-L249)
- [search_utils.py](file://graphiti_core/search/search_utils.py#L433-L553)

## 结论
EdgeSearchConfig提供了灵活而强大的边检索能力，通过组合不同的检索方法和重排序策略，可以针对特定业务场景优化查询效果。理解各策略的业务意义和适用场景，合理配置参数，能够显著提升图数据检索的精度、多样性和实用性。