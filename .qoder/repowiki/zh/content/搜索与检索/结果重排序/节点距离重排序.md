# 节点距离重排序

<cite>
**本文档中引用的文件**  
- [search_utils.py](file://graphiti_core/search/search_utils.py#L1750-L1802)
- [search.py](file://graphiti_core/search/search.py#L293-L300)
- [search.py](file://graphiti_core/search/search.py#L406-L412)
- [search_config.py](file://graphiti_core/search/search_config.py#L53-L67)
</cite>

## 目录
1. [简介](#简介)
2. [核心机制](#核心机制)
3. [算法实现细节](#算法实现细节)
4. [调用流程与协同机制](#调用流程与协同机制)
5. [错误处理与参数必要性](#错误处理与参数必要性)

## 简介
节点距离重排序策略是一种基于图结构的搜索结果重排序算法，旨在通过计算候选节点与中心节点（center_node_uuid）之间的最短路径距离，对搜索结果进行上下文感知的重新排序。该策略在局部图探索和上下文感知检索场景中具有重要价值，能够优先返回与当前上下文最相关的节点，从而提升检索的准确性和相关性。

## 核心机制
节点距离重排序策略的核心机制是利用图遍历（BFS）计算候选节点与中心节点之间的最短路径距离。该算法首先通过BFS遍历图结构，找到从中心节点到所有候选节点的最短路径，然后根据路径长度对候选节点进行排序。路径越短的节点，其与中心节点的关联性越强，因此在排序中优先级越高。这种机制能够有效捕捉图结构中的局部关系，使得搜索结果更加符合上下文需求。

**Section sources**
- [search_utils.py](file://graphiti_core/search/search_utils.py#L1750-L1802)

## 算法实现细节
`node_distance_reranker`函数是节点距离重排序策略的核心实现。该函数接收图驱动器（GraphDriver）、候选节点UUID列表（node_uuids）、中心节点UUID（center_node_uuid）和最小分数（min_score）作为参数。函数首先过滤掉与中心节点相同的候选节点，然后通过图查询计算每个候选节点与中心节点之间的最短路径距离。具体实现中，函数使用Cypher查询语言执行BFS遍历，找到从中心节点到每个候选节点的最短路径，并将路径长度作为评分依据。最后，函数根据评分对候选节点进行排序，并返回排序后的节点UUID列表和对应的评分列表。

**Section sources**
- [search_utils.py](file://graphiti_core/search/search_utils.py#L1750-L1802)

## 调用流程与协同机制
在`edge_search`和`node_search`函数中，`node_distance_reranker`被作为重排序器调用。当配置了`NodeReranker.node_distance`或`EdgeReranker.node_distance`时，搜索流程会首先执行初步的搜索方法（如BM25、余弦相似度等），然后将初步结果传递给`node_distance_reranker`进行重排序。在重排序过程中，`node_distance_reranker`会结合RRF（Reciprocal Rank Fusion）等其他重排序策略，对候选节点进行综合评分和排序。这种协同工作机制能够充分利用多种重排序策略的优势，进一步提升搜索结果的质量。

**Section sources**
- [search.py](file://graphiti_core/search/search.py#L293-L300)
- [search.py](file://graphiti_core/search/search.py#L406-L412)

## 错误处理与参数必要性
`center_node_uuid`参数是节点距离重排序策略的必要输入。如果未提供该参数，`node_distance_reranker`函数将抛出`SearchRerankerError`异常，提示“未提供中心节点用于节点距离重排序”。这一错误处理机制确保了算法的健壮性，避免了因缺少关键参数而导致的错误结果。此外，`min_score`参数用于过滤评分低于阈值的候选节点，确保返回的搜索结果具有足够的相关性。

**Section sources**
- [search.py](file://graphiti_core/search/search.py#L277-L278)
- [search.py](file://graphiti_core/search/search.py#L405-L406)