# 配置与部署

<cite>
**本文档中引用的文件**
- [.env.example](file://.env.example)
- [mcp_server/.env.example](file://mcp_server/.env.example)
- [server/.env.example](file://server/.env.example)
- [mcp_server/config/config.yaml](file://mcp_server/config/config.yaml)
- [mcp_server/docker/Dockerfile](file://mcp_server/docker/Dockerfile)
- [Dockerfile](file://Dockerfile)
- [docker-compose.yml](file://docker-compose.yml)
- [mcp_server/docker/docker-compose.yml](file://mcp_server/docker/docker-compose.yml)
- [mcp_server/config/config-docker-falkordb.yaml](file://mcp_server/config/config-docker-falkordb.yaml)
- [mcp_server/config/config-docker-neo4j.yaml](file://mcp_server/config/config-docker-neo4j.yaml)
- [mcp_server/README.md](file://mcp_server/README.md)
- [server/README.md](file://server/README.md)
- [mcp_server/docker/docker-compose-neo4j.yml](file://mcp_server/docker/docker-compose-neo4j.yml)
- [mcp_server/docker/docker-compose-falkordb.yml](file://mcp_server/docker/docker-compose-falkordb.yml)
- [mcp_server/docker/README.md](file://mcp_server/docker/README.md)
</cite>

## 目录
1. [环境变量配置](#环境变量配置)
2. [YAML配置文件详解](#yaml配置文件详解)
3. [Docker容器化部署](#docker容器化部署)
4. [Kubernetes部署建议](#kubernetes部署建议)
5. [部署模式比较](#部署模式比较)
6. [监控与健康检查](#监控与健康检查)

## 环境变量配置

本项目使用环境变量文件（.env）来管理敏感信息和可配置参数。环境变量在不同组件中具有不同的配置要求。

### 核心环境变量

核心项目根目录下的 `.env.example` 文件定义了全局环境变量：

- `OPENAI_API_KEY`: OpenAI API密钥，用于LLM操作
- `NEO4J_URI`: Neo4j数据库连接URI
- `NEO4J_PORT`: Neo4j端口
- `NEO4J_USER`: Neo4j用户名
- `NEO4J_PASSWORD`: Neo4j密码
- `FALKORDB_URI`: FalkorDB数据库连接URI
- `FALKORDB_PORT`: FalkorDB端口
- `FALKORDB_USER`: FalkorDB用户名
- `FALKORDB_PASSWORD`: FalkorDB密码
- `USE_PARALLEL_RUNTIME`: 是否使用并行运行时
- `SEMAPHORE_LIMIT`: 信号量限制，控制并发处理
- `GITHUB_SHA`: GitHub SHA标识
- `MAX_REFLEXION_ITERATIONS`: 最大反思迭代次数
- `ANTHROPIC_API_KEY`: Anthropic API密钥

**Section sources**
- [.env.example](file://.env.example)

### MCP服务器环境变量

MCP服务器专用的 `.env.example` 文件包含更详细的配置选项：

- `NEO4J_URI`: Neo4j URI，默认为 `bolt://localhost:7687`
- `NEO4J_USER`: Neo4j用户名，默认为 `neo4j`
- `NEO4J_PASSWORD`: Neo4j密码，默认为 `demodemo`
- `OPENAI_API_KEY`: OpenAI API密钥，必需
- `MODEL_NAME`: 模型名称，默认为 `gpt-4.1-mini`
- `SEMAPHORE_LIMIT`: 信号量限制，默认为10，根据LLM提供商的速率限制调整
- `AZURE_OPENAI_ENDPOINT`: Azure OpenAI端点
- `AZURE_OPENAI_API_VERSION`: Azure OpenAI API版本
- `AZURE_OPENAI_DEPLOYMENT_NAME`: Azure OpenAI部署名称
- `AZURE_OPENAI_EMBEDDING_API_VERSION`: Azure OpenAI嵌入API版本
- `AZURE_OPENAI_EMBEDDING_DEPLOYMENT_NAME`: Azure OpenAI嵌入部署名称
- `AZURE_OPENAI_USE_MANAGED_IDENTITY`: 是否使用Azure托管身份

**Section sources**
- [mcp_server/.env.example](file://mcp_server/.env.example)

### 服务器环境变量

服务器组件的 `.env.example` 文件包含以下配置：

- `OPENAI_API_KEY`: OpenAI API密钥
- `NEO4J_PORT`: Neo4j端口，默认为7687
- `NEO4J_URI`: Neo4j URI，默认为 `bolt://localhost:7687`
- `NEO4J_USER`: Neo4j用户名，默认为 `neo4j`
- `NEO4J_PASSWORD`: Neo4j密码，默认为 `password`

**Section sources**
- [server/.env.example](file://server/.env.example)

## YAML配置文件详解

YAML配置文件提供了比环境变量更复杂的层级结构和可选参数配置。

### 主配置文件结构

`mcp_server/config/config.yaml` 是MCP服务器的主要配置文件，包含以下主要部分：

#### 服务器配置

```yaml
server:
  transport: "http"  # 传输方式：stdio, sse (已弃用), http
  host: "0.0.0.0"
  port: 8000
```

#### LLM配置

```yaml
llm:
  provider: "openai"  # 提供商：openai, azure_openai, anthropic, gemini, groq
  model: "gpt-5-mini"
  max_tokens: 4096
```

#### 嵌入提供程序配置

```yaml
embedder:
  provider: "openai"  # 提供商：openai, azure_openai, gemini, voyage
  model: "text-embedding-3-small"
  dimensions: 1536
```

#### 数据库配置

```yaml
database:
  provider: "falkordb"  # 默认：falkordb。选项：neo4j, falkordb
```

#### Graphiti配置

```yaml
graphiti:
  group_id: ${GRAPHITI_GROUP_ID:main}
  episode_id_prefix: ${EPISODE_ID_PREFIX:}
  user_id: ${USER_ID:mcp_user}
  entity_types:  # 实体类型列表
    - name: "Preference"
      description: "用户偏好、选择、意见或选择"
    - name: "Requirement"
      description: "必须满足的特定需求、功能或功能"
    # ... 其他实体类型
```

**Section sources**
- [mcp_server/config/config.yaml](file://mcp_server/config/config.yaml)

### Docker专用配置

项目提供了针对不同数据库后端的Docker专用配置文件：

#### FalkorDB Docker配置

`mcp_server/config/config-docker-falkordb.yaml` 专为FalkorDB Docker部署优化：

```yaml
database:
  provider: "falkordb"
  
  providers:
    falkordb:
      uri: ${FALKORDB_URI:redis://falkordb:6379}  # 使用Docker服务主机名
      password: ${FALKORDB_PASSWORD:}
      database: ${FALKORDB_DATABASE:default_db}
```

**Section sources**
- [mcp_server/config/config-docker-falkordb.yaml](file://mcp_server/config/config-docker-falkordb.yaml)

#### Neo4j Docker配置

`mcp_server/config/config-docker-neo4j.yaml` 专为Neo4j Docker部署优化：

```yaml
database:
  provider: "neo4j"
  
  providers:
    neo4j:
      uri: ${NEO4J_URI:bolt://neo4j:7687}  # 使用Docker服务主机名
      username: ${NEO4J_USER:neo4j}
      password: ${NEO4J_PASSWORD:demodemo}
      database: ${NEO4J_DATABASE:neo4j}
      use_parallel_runtime: ${USE_PARALLEL_RUNTIME:false}
```

**Section sources**
- [mcp_server/config/config-docker-neo4j.yaml](file://mcp_server/config/config-docker-neo4j.yaml)

## Docker容器化部署

项目提供了完整的Docker容器化部署流程，支持多种编排方式。

### 构建镜像

项目包含两个Dockerfile，分别用于不同的部署场景：

#### MCP服务器Dockerfile

`mcp_server/docker/Dockerfile` 创建了一个包含FalkorDB和MCP服务器的组合镜像：

- 基于 `falkordb/falkordb:latest` 镜像
- 安装Python和系统依赖
- 使用 `uv` 进行Python包管理
- 复制项目文件并安装依赖
- 复制MCP服务器应用代码
- 创建启动脚本同时运行FalkorDB和MCP服务器
- 暴露端口：6379 (FalkorDB), 3000 (FalkorDB浏览器), 8000 (MCP服务器)

**Section sources**
- [mcp_server/docker/Dockerfile](file://mcp_server/docker/Dockerfile)

#### 服务器Dockerfile

`Dockerfile` 用于构建FastAPI服务器镜像：

- 基于 `python:3.12-slim`
- 安装 `uv` 包管理器
- 创建非root用户
- 安装服务器依赖
- 设置环境变量
- 暴露端口8000
- 使用uv运行Uvicorn服务器

**Section sources**
- [Dockerfile](file://Dockerfile)

### 运行容器

#### 使用Docker Compose

项目提供了多个docker-compose配置文件，支持不同的部署场景。

##### 核心Docker Compose

`docker-compose.yml` 定义了核心服务：

- `graph` 服务：构建并运行服务器，映射端口8000
- `neo4j` 服务：使用Neo4j 5.26.2镜像，映射HTTP端口7474和Bolt端口7687
- `falkordb` 服务：使用FalkorDB镜像，映射端口6379
- `graph-falkordb` 服务：使用FalkorDB后端的服务器实例

```yaml
services:
  graph:
    build:
      context: .
    ports:
      - "8000:8000"
    depends_on:
      neo4j:
        condition: service_healthy
    environment:
      - OPENAI_API_KEY=${OPENAI_API_KEY}
      - NEO4J_URI=bolt://neo4j:${NEO4J_PORT:-7687}
      # ... 其他环境变量
  neo4j:
    image: neo4j:5.26.2
    ports:
      - "7474:7474"
      - "${NEO4J_PORT:-7687}:${NEO4J_PORT:-7687}"
    volumes:
      - neo4j_data:/data
    environment:
      - NEO4J_AUTH=${NEO4J_USER:-neo4j}/${NEO4J_PASSWORD:-password}
```

**Section sources**
- [docker-compose.yml](file://docker-compose.yml)

##### MCP服务器Docker Compose

`mcp_server/docker/docker-compose.yml` 用于运行MCP服务器：

- `graphiti-falkordb` 服务：构建或使用预构建镜像
- 使用 `mcp_server/.env` 文件配置环境变量
- 映射端口：6379 (FalkorDB), 3000 (FalkorDB UI), 8000 (MCP服务器)
- 使用命名卷 `falkordb_data` 和 `mcp_logs` 持久化数据

```yaml
services:
  graphiti-falkordb:
    image: zepai/knowledge-graph-mcp:latest
    build:
      context: ..
      dockerfile: docker/Dockerfile
    env_file:
      - path: ../.env
        required: false
    environment:
      - FALKORDB_PASSWORD=${FALKORDB_PASSWORD:-}
      - BROWSER=${BROWSER:-1}
      - FALKORDB_URI=redis://localhost:6379
      # ... 其他环境变量
    volumes:
      - falkordb_data:/var/lib/falkordb/data
      - mcp_logs:/var/log/graphiti
    ports:
      - "6379:6379"
      - "3000:3000"
      - "8000:8000"
```

**Section sources**
- [mcp_server/docker/docker-compose.yml](file://mcp_server/docker/docker-compose.yml)

##### Neo4j专用Docker Compose

`mcp_server/docker/docker-compose-neo4j.yml` 用于Neo4j部署：

- `neo4j` 服务：使用Neo4j 5.26.0镜像
- `graphiti-mcp` 服务：使用独立的MCP服务器镜像
- 配置Neo4j内存设置
- 使用命名卷 `neo4j_data` 和 `neo4j_logs` 持久化数据

**Section sources**
- [mcp_server/docker/docker-compose-neo4j.yml](file://mcp_server/docker/docker-compose-neo4j.yml)

##### FalkorDB专用Docker Compose

`mcp_server/docker/docker-compose-falkordb.yml` 用于FalkorDB部署：

- `falkordb` 服务：使用FalkorDB镜像
- `graphiti-mcp` 服务：使用独立的MCP服务器镜像
- 映射FalkorDB端口6379和Web UI端口3000
- 使用命名卷 `falkordb_data` 持久化数据

**Section sources**
- [mcp_server/docker/docker-compose-falkordb.yml](file://mcp_server/docker/docker-compose-falkordb.yml)

### 部署流程

完整的Docker部署流程如下：

1. **配置环境变量**：
   ```bash
   cd graphiti/mcp_server
   cp .env.example .env
   # 编辑 .env 文件设置API密钥
   ```

2. **运行Docker Compose**：
   ```bash
   # 默认：FalkorDB组合容器
   docker compose up
   
   # Neo4j数据库
   docker compose -f docker/docker-compose-neo4j.yml up
   
   # FalkorDB分离容器
   docker compose -f docker/docker-compose-falkordb.yml up
   ```

3. **访问服务**：
   - MCP服务器HTTP端点：`http://localhost:8000/mcp/`
   - 健康检查：`http://localhost:8000/health`
   - Neo4j浏览器：`http://localhost:7474`
   - FalkorDB Web UI：`http://localhost:3000`

**Section sources**
- [mcp_server/README.md](file://mcp_server/README.md)
- [mcp_server/docker/README.md](file://mcp_server/docker/README.md)

## Kubernetes部署建议

虽然项目没有提供直接的Kubernetes配置文件，但可以根据Docker Compose配置推导出Kubernetes部署策略。

### 基本部署策略

1. **创建ConfigMap**：将YAML配置文件转换为ConfigMap
2. **创建Secret**：将敏感信息（API密钥、密码）存储在Secret中
3. **部署StatefulSet**：为数据库组件（Neo4j或FalkorDB）创建StatefulSet
4. **部署Deployment**：为应用服务器创建Deployment
5. **创建Service**：暴露服务端口
6. **配置PersistentVolumeClaim**：确保数据持久化

### 资源配置建议

- **Neo4j**：建议分配至少2GB内存，配置适当的堆大小和页面缓存
- **FalkorDB**：作为Redis模块运行，需要足够的内存来存储图数据
- **应用服务器**：根据预期负载分配CPU和内存资源

### 环境变量映射

Kubernetes中的环境变量应从Secret中引用，例如：

```yaml
env:
  - name: OPENAI_API_KEY
    valueFrom:
      secretKeyRef:
        name: graphiti-secrets
        key: openai-api-key
  - name: NEO4J_PASSWORD
    valueFrom:
      secretKeyRef:
        name: graphiti-secrets
        key: neo4j-password
```

## 部署模式比较

项目支持多种部署模式，各有优劣。

### 单体部署模式

#### 优点

- **简单性**：部署和管理简单
- **性能**：组件间通信延迟低
- **资源效率**：共享资源，减少开销
- **快速启动**：适合开发和测试环境

#### 缺点

- **可扩展性**：难以独立扩展组件
- **可靠性**：单点故障风险
- **技术栈限制**：所有组件必须使用兼容的技术栈

#### 适用场景

- 开发和测试环境
- 小型项目
- 资源受限环境

### 微服务部署模式

#### 优点

- **可扩展性**：可以独立扩展数据库和应用服务器
- **可靠性**：故障隔离，提高系统可用性
- **技术灵活性**：不同组件可以使用最适合的技术
- **维护性**：独立更新和部署组件

#### 缺点

- **复杂性**：部署和管理更复杂
- **网络开销**：组件间通信增加网络延迟
- **资源开销**：每个服务需要独立的资源分配

#### 适用场景

- 生产环境
- 大型项目
- 高可用性要求

### 混合部署模式

项目支持混合部署模式，如FalkorDB组合镜像：

#### 优点

- **平衡**：在简单性和可扩展性之间取得平衡
- **性能**：数据库和应用在同一容器内，通信高效
- **管理**：比完全分离的微服务更容易管理

#### 缺点

- **扩展限制**：无法独立扩展数据库和应用
- **资源竞争**：同一容器内的资源竞争

## 监控与健康检查

项目提供了完善的监控和健康检查机制。

### 健康检查配置

#### Docker健康检查

Docker配置中包含了健康检查：

```yaml
healthcheck:
  test: ["CMD", "redis-cli", "-p", "6379", "ping"]
  interval: 10s
  timeout: 5s
  retries: 5
  start_period: 15s
```

对于Neo4j，使用wget检查HTTP端点：

```yaml
healthcheck:
  test: ["CMD-SHELL", "wget -qO- http://localhost:${NEO4J_PORT:-7474} || exit 1"]
  interval: 1s
  timeout: 10s
  retries: 10
  start_period: 3s
```

#### HTTP健康检查

应用服务器提供HTTP健康检查端点：

```yaml
healthcheck:
  test:
    [
      "CMD",
      "python",
      "-c",
      "import urllib.request; urllib.request.urlopen('http://localhost:8000/healthcheck')"
    ]
  interval: 10s
  timeout: 5s
  retries: 3
```

**Section sources**
- [docker-compose.yml](file://docker-compose.yml)
- [mcp_server/docker/docker-compose.yml](file://mcp_server/docker/docker-compose.yml)

### 日志配置

#### 日志位置

- MCP服务器日志：`/var/log/graphiti/`
- 浏览器日志：`/var/log/graphiti/browser.log`

#### 日志管理

使用命名卷持久化日志：

```yaml
volumes:
  - mcp_logs:/var/log/graphiti
```

### 指标监控

#### 性能监控

- **FalkorDB**: 使用Redis命令监控内存使用情况
  ```bash
  docker compose exec graphiti-falkordb redis-cli info memory
  ```

- **Neo4j**: 在Neo4j浏览器中检查查询性能

#### 资源监控

使用Docker stats监控容器资源使用：

```bash
docker stats graphiti-falkordb
```

### 并发控制

通过`SEMAPHORE_LIMIT`环境变量控制并发处理：

- **OpenAI**: 根据订阅层级调整
  - 免费层：1-2
  - 第2层：5-8
  - 第3层：10-15
  - 第4层：20-50

- **Anthropic**: 
  - 默认层：5-8
  - 高级层：15-30

- **Ollama (本地)**: 1-5，根据硬件调整

**Section sources**
- [mcp_server/README.md](file://mcp_server/README.md)